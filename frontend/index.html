<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management Dashboard</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body class="bg-slate-50">
    <div class="min-h-screen" x-data="dashboardApp()" @htmx:afterRequest="onRequestComplete()">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900">Task Management</h1>
                        <p class="text-slate-600 text-sm mt-1">Real-time task tracking and management</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-600">Metrics: <span x-text="taskCount" class="font-semibold text-blue-600">0</span> tasks</p>
                        <p class="text-xs text-slate-500 mt-1">Status: <span x-text="apiStatus" class="font-semibold" :class="apiStatus === 'Online' ? 'text-green-600' : 'text-red-600'">Checking...</span></p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Actions Sidebar -->
                <aside class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow p-6 sticky top-8">
                        <h2 class="text-lg font-semibold text-slate-900 mb-4">Actions</h2>
                        <button
                            @click="toggleCreateForm()"
                            class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium mb-3"
                        >
                            + New Task
                        </button>
                        <div class="space-y-2">
                            <button
                                @click="activeFilter = 'all'; loadTasks()"
                                :class="activeFilter === 'all' ? 'bg-blue-100 text-blue-700' : 'text-slate-700 hover:bg-slate-100'"
                                class="w-full px-4 py-2 rounded text-left transition"
                            >
                                All Tasks
                            </button>
                            <button
                                @click="activeFilter = 'pending'; loadTasks()"
                                :class="activeFilter === 'pending' ? 'bg-yellow-100 text-yellow-700' : 'text-slate-700 hover:bg-slate-100'"
                                class="w-full px-4 py-2 rounded text-left transition"
                            >
                                Pending
                            </button>
                            <button
                                @click="activeFilter = 'in_progress'; loadTasks()"
                                :class="activeFilter === 'in_progress' ? 'bg-purple-100 text-purple-700' : 'text-slate-700 hover:bg-slate-100'"
                                class="w-full px-4 py-2 rounded text-left transition"
                            >
                                In Progress
                            </button>
                            <button
                                @click="activeFilter = 'completed'; loadTasks()"
                                :class="activeFilter === 'completed' ? 'bg-green-100 text-green-700' : 'text-slate-700 hover:bg-slate-100'"
                                class="w-full px-4 py-2 rounded text-left transition"
                            >
                                Completed
                            </button>
                        </div>
                    </div>
                </aside>

                 <!-- System Info Panel -->
                 <aside class="lg:col-span-1">
                     <div class="bg-white rounded-lg shadow p-6 sticky top-8">
                         <h3 class="text-lg font-semibold text-slate-900 mb-4">System Info</h3>
                         <div class="space-y-3 text-sm">
                             <div class="flex justify-between items-center">
                                 <span class="text-slate-600">API:</span>
                                 <span class="text-slate-900 font-medium">http://api:8080</span>
                             </div>
                             <div class="flex justify-between items-center">
                                 <span class="text-slate-600">Metrics:</span>
                                 <a href="http://localhost:9090/" target="_blank" class="text-blue-600 hover:underline">Prometheus</a>
                             </div>
                             <div class="flex justify-between items-center">
                                 <span class="text-slate-600">Docs:</span>
                                 <a href="http://localhost:8080/swagger/index.html" target="_blank" class="text-blue-600 hover:underline">Swagger</a>
                             </div>
                         </div>
                     </div>
                 </aside>

                <!-- Main Content Area -->
                <section class="lg:col-span-2">
                    <!-- Create/Edit Task Form -->
                    <div x-show="showCreateForm" class="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 class="text-xl font-semibold text-slate-900 mb-4" x-text="isEditing ? 'Edit Task' : 'Create New Task'"></h2>
                        <form
                            @submit.prevent="isEditing ? updateTask() : createTask()"
                            class="space-y-4"
                        >
                             <div>
                                 <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
                                 <input
                                     x-model="newTask.title"
                                     type="text"
                                     placeholder="Enter task title..."
                                     class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                     @input="validateTitle()"
                                 >
                                 <p x-show="errors.title" class="text-red-500 text-sm mt-1" x-text="errors.title"></p>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                                 <textarea
                                     x-model="newTask.description"
                                     placeholder="Enter task description..."
                                     rows="3"
                                     class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                 ></textarea>
                             </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                                    <select
                                        x-model="newTask.status"
                                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                        <option value="pending">Pending</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                 <div>
                                     <label class="block text-sm font-medium text-slate-700 mb-1">Assignee</label>
                                     <input
                                         x-model="newTask.assignee"
                                         type="text"
                                         placeholder="Enter assignee..."
                                         class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                     >
                                 </div>
                            </div>
                            <div class="flex gap-3">
                                <button
                                    type="submit"
                                    class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-medium"
                                    :disabled="isLoading"
                                >
                                    <span x-text="isLoading ? (isEditing ? 'Updating...' : 'Creating...') : (isEditing ? 'Update Task' : 'Create Task')"></span>
                                </button>
                                <button
                                    type="button"
                                    @click="toggleCreateForm()"
                                    class="flex-1 bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300 transition font-medium"
                                >
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Tasks List -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-6 py-4 border-b border-slate-200">
                            <h2 class="text-lg font-semibold text-slate-900">
                                <span x-text="activeFilter === 'all' ? 'All Tasks' : activeFilter.charAt(0).toUpperCase() + activeFilter.slice(1).replace('_', ' ')"></span>
                                <span class="text-sm font-normal text-slate-600 ml-2" x-text="'(' + tasks.length + ')'"></span>
                            </h2>
                        </div>

                        <!-- Empty State -->
                        <div x-show="tasks.length === 0" class="px-6 py-12 text-center">
                            <p class="text-slate-500">No tasks found. Create one to get started!</p>
                        </div>

                        <!-- Tasks Grid -->
                        <div x-show="tasks.length > 0" class="divide-y divide-slate-200">
                            <template x-for="task in tasks" :key="task.id">
                                <div class="px-6 py-4 hover:bg-slate-50 transition">
                                    <div class="flex items-start justify-between gap-4">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-3 mb-2">
                                                <h3 class="text-lg font-medium text-slate-900 truncate" x-text="task.title"></h3>
                                                <span
                                                    class="px-2 py-1 text-xs font-semibold rounded"
                                                    :class="getStatusClass(task.status)"
                                                    x-text="task.status.replace('_', ' ')"
                                                ></span>
                                            </div>
                                            <p class="text-slate-600 text-sm mb-2" x-text="task.description"></p>
                                            <div class="flex gap-4 text-xs text-slate-500">
                                                <span x-text="'Created: ' + formatDate(task.created_at)"></span>
                                                <span x-text="'Updated: ' + formatDate(task.updated_at)"></span>
                                            </div>
                                        </div>
                                        <div class="flex gap-2">
                                            <button
                                                @click="editTask(task)"
                                                class="p-2 text-blue-600 hover:bg-blue-50 rounded transition"
                                                title="Edit"
                                            >
                                                ‚úèÔ∏è
                                            </button>
                                            <button
                                                @click="deleteTask(task.id)"
                                                class="p-2 text-red-600 hover:bg-red-50 rounded transition"
                                                title="Delete"
                                            >
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                     </div>
                 </section>

                 <!-- Alerts Panel -->
                 <aside class="lg:col-span-1">
                     <div class="bg-white rounded-lg shadow p-6 sticky top-8">
                         <h3 class="text-lg font-semibold text-slate-900 mb-4">Alerts</h3>
                         <div class="space-y-3">
                             <div class="flex gap-2">
                                 <input
                                     x-model="newAlertName"
                                     type="text"
                                     placeholder="Alert name"
                                     class="flex-1 px-2 py-1 text-sm border border-slate-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                                 >
                                 <button
                                     @click="fireAlert()" style="min-width: 100px;"
                                     class="  py-1 w-100 bg-red-600 text-white   rounded hover:bg-red-700 transition"
                                     title="Fire Alert"
                                 >
                                     üî• Fire Alert
                                 </button>
                             </div>
                             <button
                                 @click="resetAlert()"
                                 class="w-full px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition"
                                 title="Reset Alert"
                             >
                                 Reset Alert
                             </button>
                             <div class="border-t border-slate-200 pt-3">
                                 <h4 class="text-sm font-medium text-slate-700 mb-2">Active Alerts</h4>
                                 <div x-show="alerts.length === 0" class="text-xs text-slate-500">No active alerts</div>
                                 <div x-show="alerts.length > 0" class="space-y-2 max-h-40 overflow-y-auto">
                                     <template x-for="alert in alerts" :key="alert.labels.alertname">
                                         <div class="bg-red-50 border border-red-200 rounded p-2">
                                             <div class="text-xs font-medium text-red-800" x-text="alert.labels.alertname"></div>
                                             <div class="text-xs text-red-600" x-text="alert.annotations.summary"></div>
                                             <div class="text-xs text-red-500" x-text="alert.state + ' since ' + formatDate(alert.activeAt)"></div>
                                         </div>
                                     </template>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </aside>
             </div>
        </main>

        <!-- Toast Notifications -->
        <div class="fixed bottom-4 right-4 space-y-2">
            <template x-for="toast in toasts" :key="toast.id">
                <div
                    class="px-4 py-3 rounded-lg shadow text-white font-medium"
                    :class="toast.type === 'success' ? 'bg-green-600' : 'bg-red-600'"
                    x-text="toast.message"
                    @click="removeToast(toast.id)"
                    style="cursor: pointer;"
                ></div>
            </template>
        </div>
    </div>

    <script>
        function dashboardApp() {
            return {
                tasks: [],
                newTask: {
                    title: '',
                    description: '',
                    status: 'pending',
                    assignee: ''
                },
                showCreateForm: false,
                isEditing: false,
                editingTaskId: null,
                activeFilter: 'all',
                taskCount: 0,
                apiStatus: 'Checking...',
                isLoading: false,
                toasts: [],
                toastId: 0,
                alerts: [],
                newAlertName: '',
                errors: {
                    title: ''
                },

                validateTitle() {
                    const title = this.newTask.title.trim();
                    if (!title) {
                        this.errors.title = 'Title is required';
                    } else if (title.length > 200) {
                        this.errors.title = 'Title must be at most 200 characters';
                    } else {
                        this.errors.title = '';
                    }
                },

                validateForm() {
                    this.validateTitle();
                    return !this.errors.title;
                },

                clearErrors() {
                    this.errors = {
                        title: ''
                    };
                },

                init() {
                    this.loadTasks();
                    this.checkHealth();
                    this.loadAlerts();
                    setInterval(() => this.loadTasks(), 5000);
                    setInterval(() => this.checkHealth(), 10000);
                    setInterval(() => this.loadAlerts(), 10000);
                },

                async loadTasks() {
                    try {
                        const url = this.activeFilter === 'all'
                            ? '/api/v1/tasks'
                            : `/api/v1/tasks?status=${this.activeFilter}`;

                        const response = await fetch(url);
                        if (!response.ok) throw new Error('Failed to load tasks');

                        const data = await response.json();
                        this.tasks = data.tasks || [];
                        this.taskCount = this.tasks.length;
                    } catch (error) {
                        this.showToast('Failed to load tasks', 'error');
                        console.error(error);
                    }
                },

                async loadAlerts() {
                    try {
                        const response = await fetch('/api/v1/alerts');
                        if (!response.ok) throw new Error('Failed to load alerts');

                        const data = await response.json();
                        this.alerts = data.data.alerts || [];
                    } catch (error) {
                        console.error('Error loading alerts:', error);
                    }
                },

                async fireAlert() {
                    if (!this.newAlertName.trim()) {
                        this.showToast('Alert name is required', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/api/v1/alerts/fire', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ alert_name: this.newAlertName })
                        });

                        if (!response.ok) throw new Error('Failed to fire alert');

                        this.showToast('Alert fired successfully', 'success');
                        this.newAlertName = '';
                        await this.loadAlerts();
                    } catch (error) {
                        this.showToast('Error firing alert', 'error');
                        console.error(error);
                    }
                },

                async resetAlert() {
                    if (!this.newAlertName.trim()) {
                        this.showToast('Alert name is required', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/api/v1/alerts/reset', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ alert_name: this.newAlertName })
                        });

                        if (!response.ok) throw new Error('Failed to reset alert');

                        this.showToast('Alert reset successfully', 'success');
                        this.newAlertName = '';
                        await this.loadAlerts();
                    } catch (error) {
                        this.showToast('Error resetting alert', 'error');
                        console.error(error);
                    }
                },

                async createTask() {
                    if (!this.validateForm()) {
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const response = await fetch('/api/v1/tasks', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newTask)
                        });

                        if (!response.ok) throw new Error('Failed to create task');

                        this.showToast('Task created successfully', 'success');
                        this.newTask = {
                            title: '',
                            description: '',
                            status: 'pending',
                            assignee: ''
                        };
                        this.showCreateForm = false;
                        await this.loadTasks();
                    } catch (error) {
                        this.showToast('Error creating task', 'error');
                        console.error(error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async updateTask() {
                    if (!this.validateForm()) {
                        return;
                    }

                    this.isLoading = true;
                    try {
                        const response = await fetch(`/api/v1/tasks/${this.editingTaskId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newTask)
                        });

                        if (!response.ok) throw new Error('Failed to update task');

                        this.showToast('Task updated successfully', 'success');
                        this.isEditing = false;
                        this.editingTaskId = null;
                        this.newTask = {
                            title: '',
                            description: '',
                            status: 'pending',
                            assignee: ''
                        };
                        this.showCreateForm = false;
                        await this.loadTasks();
                    } catch (error) {
                        this.showToast('Error updating task', 'error');
                        console.error(error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async deleteTask(id) {
                    if (!confirm('Are you sure you want to delete this task?')) return;

                    try {
                        const response = await fetch(`/api/v1/tasks/${id}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) throw new Error('Failed to delete task');

                        this.showToast('Task deleted successfully', 'success');
                        await this.loadTasks();
                    } catch (error) {
                        this.showToast('Error deleting task', 'error');
                        console.error(error);
                    }
                },

                async editTask(task) {
                    try {
                        const response = await fetch(`/api/v1/tasks/${task.id}`);
                        if (!response.ok) throw new Error('Failed to load task');

                        const data = await response.json();
                        const loadedTask = data;

                        this.isEditing = true;
                        this.editingTaskId = loadedTask.id;
                        this.newTask = {
                            title: loadedTask.title,
                            description: loadedTask.description,
                            status: loadedTask.status,
                            assignee: loadedTask.assignee || ''
                        };
                        this.clearErrors();
                        this.showCreateForm = true;
                        window.scrollTo(0, 0);
                    } catch (error) {
                        this.showToast('Failed to load task for editing', 'error');
                        console.error(error);
                    }
                },

                async checkHealth() {
                    try {
                        const response = await fetch('/api/v1/health');
                        this.apiStatus = response.ok ? 'Online' : 'Offline';
                    } catch (error) {
                        this.apiStatus = 'Offline';
                    }
                },

                toggleCreateForm() {
                    this.showCreateForm = !this.showCreateForm;
                    if (!this.showCreateForm) {
                        this.isEditing = false;
                        this.editingTaskId = null;
                        this.newTask = {
                            title: '',
                            description: '',
                            status: 'pending',
                            assignee: ''
                        };
                        this.clearErrors();
                    }
                },

                showToast(message, type = 'success') {
                    const id = this.toastId++;
                    this.toasts.push({ id, message, type });
                    setTimeout(() => this.removeToast(id), 3000);
                },

                removeToast(id) {
                    this.toasts = this.toasts.filter(t => t.id !== id);
                },

                getStatusClass(status) {
                    const classes = {
                        'pending': 'bg-yellow-100 text-yellow-800',
                        'in_progress': 'bg-purple-100 text-purple-800',
                        'completed': 'bg-green-100 text-green-800'
                    };
                    return classes[status] || 'bg-slate-100 text-slate-800';
                },

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    const date = new Date(dateString);
                    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                },

                onRequestComplete() {
                    this.loadTasks();
                }
            };
        }
    </script>
</body>
</html>
